<#
.SYNOPSIS
    Ensures Accounts must be configured to require password expiration (STIG: WN10-00-000090).

.DESCRIPTION
    Configures registry to enable script block logging:
    HKLM\SOFTWARE\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging\EnableScriptBlockLogging = 1

.NOTES
    Author          : Harrison Knapp
    GitHub          : https://github.com/hknapp518/hknapp518
    Date Created    : 2025-08-24
    Last Modified   : 2025-08-24
    Version         : 1.0
    STIG-ID         : WN10-00-000090# 
.TESTED ON
    Date(s) Tested  : 
    Tested By       : 
    Systems Tested  : 
    PowerShell Ver. : 

# Get all local, enabled user accounts
$users = Get-WmiObject Win32_UserAccount -Filter "LocalAccount='True' AND Disabled='False'"

foreach ($user in $users) {
    try {
        # Skip built-in accounts (RID 500 = Administrator, RID 501 = Guest)
        if ($user.SID -match '-500$' -or $user.SID -match '-501$') {
            Write-Output "Skipping built-in account: $($user.Name)"
            continue
        }

        # Get the ADSI object for the user
        $adsi = [ADSI]"WinNT://$($env:COMPUTERNAME)/$($user.Name),user"

        # Check if "Password never expires" is set
        if ($adsi.UserFlags.Value -band 0x10000) {
            # Clear the flag (0x10000 = DONT_EXPIRE_PASSWD)
            $adsi.UserFlags.Value = $adsi.UserFlags.Value -bxor 0x10000
            $adsi.SetInfo()
            Write-Output "Updated account: $($user.Name) — Password now expires."
        } else {
            Write-Output "Account: $($user.Name) already configured correctly."
        }
    } catch {
        Write-Warning "Failed to update account $($user.Name): $($_.Exception.Message)"
    }
}
